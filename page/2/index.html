<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="前进，前进，不择手段的野蛮前进。">
<meta property="og:type" content="website">
<meta property="og:title" content="碧云轩">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="碧云轩">
<meta property="og:description" content="前进，前进，不择手段的野蛮前进。">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="碧云轩">
<meta name="twitter:description" content="前进，前进，不择手段的野蛮前进。">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: 'sky'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/page/2/"/>

  <title> 碧云轩 - 前进，前进，不择手段的野蛮前进。 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?76b3ed277c6e2e5651636f036f6c1428";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">碧云轩</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="#" class="st-search-show-outputs">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <form class="site-search-form">
  <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
</form>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'ZRCiygcbA1PQanhkr_pi','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/05/2016-05-31-lua-ffi-summary.html" itemprop="url">
                  luajit ffi 总结 <转载>
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-07-05T21:29:45+08:00" content="2016-07-05">
              2016-07-05
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/07/05/2016-05-31-lua-ffi-summary.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/07/05/2016-05-31-lua-ffi-summary.html" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
            &nbsp; | &nbsp;
            <span id="/2016/07/05/2016-05-31-lua-ffi-summary.html"class="leancloud_visitors" data-flag-title="luajit ffi 总结 <转载>">
                     &nbsp;阅读次数
                    </span>
          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Lua 是一种语法简单，上手快的语言，虽然原生库比较少，但是可以方便的和 C 语言互相调用，常被用于脚本嵌入到 C 程序中。如 Redis 中可以加载 Lua 脚本，作用类似于存储过程，Nginx 中 lua-nginx-module 模块更是将 Lua 的这种特性发挥到极致。</p>
<p>使用 Lua 如何调用 C 的函数，个人认为是每一个 Lua 开发者必学的内容。Lua 调用 C 程序有两种方法，一种是使用 lua C API，另一种方法就是使用 luajit 提供的 ffi 库来调用 C 程序。本文主要是对 luajit ffi 的研究总结。</p>
<p>#luajit ffi</p>
<p>luajit 和 lua 一样，是可以直接安装在操作系统中的，相关介绍直接参考官网 luajit。个人测试效果来看，luajit 的执行效率远高于 lua，大概是 8 倍左右。openresty 的 lua-nginx-module 模块就是将 luajit 集成到了 Nginx 中，实现在 Nginx 中执行 Lua 脚本</p>
<p>luajit ffi 是 luajit 提供给 Luaer 使用 Lua 调用 C 函数的 Lua 库，使用该库，Luaer 不用再去操作复杂的 Lua 栈来粘合两种程序代码，luajit ffi 官方资料。</p>
<p>##引入 luajit ffi 库</p>
<pre><code>local ffi = require(&quot;ffi&quot;)
</code></pre><p>#在 Lua 中调用 C 函数</p>
<p>和 lua 的 C API 一样，Lua 调用 C 函数，需要将 C 函数编译成链接库。区别在于 C API 查找 C 的 Lua 库是在 package.cpath 路径下进行查找，而这些库函数使用 Lua 栈接口进行编写。而 luajit 对于 C 链接库的引用遵从于普通 C 库的引用方式，先在 /usr/lib(/usr/lib64)，/lib(/lib64) 目录下查找，再到用户自定义的 LD_LIBRARY_PATH 下查找。</p>
<p>本节涉及接口：</p>
<pre><code> ffi.cdef[[c_function define]]
ffi.C
ffi.load(name [,global])
</code></pre><ul>
<li><p>调用 C 标准库函数</p>
<p> 对于 C 标准库函数引用，需要引入函数，函数声明</p>
<pre><code>ffi.cdef[[c_function define]]
</code></pre><p>  调用 C 函数</p>
<pre><code>ffi.C.c_function
</code></pre><p>  如：</p>
<pre><code>local ffi = require(&quot;ffi&quot;)

ffi.cdef[[
    int printf(const char *fmt, ...);
    int strcasecmp(const char *s1, const char *s2);
]]

ffi.C.printf(&quot;Hello %s!\n&quot;, &quot;world&quot;)
ret = ffi.C.strcasecmp(&quot;Hello&quot;, &quot;hello&quot;)
print(ret)
ret = ffi.C.strcasecmp(&quot;Hello&quot;, &quot;hello1&quot;)
print(ret)
</code></pre><p>  输出结果</p>
<pre><code>[root@AlexWoo-CentOS lua]# luajit ffic.lua 
Hello world!
0
-49
</code></pre></li>
<li><p>调用自定义的 C 函数</p>
<p>  调用自定义的 C 函数，首先要将自定义的 C 函数编译成链接库</p>
<pre><code>[root@AlexWoo-CentOS lua]# cat ffimyc.c 
int add(int x, int y)
{
    return x + y;
}
[root@AlexWoo-CentOS lua]# gcc -g -o libffimyc.so -fpic -shared ffimyc.c
</code></pre></li>
<li><p>调用 C 标准库函数</p>
<p>   调用 C 标准库函数，需要在 Lua 中引入相应的库</p>
<pre><code>ffi.load(name [,global])
</code></pre><p>  这里第二个参数如果为 true，则该库被引入全局命名空间，这里使用 ffi.load 需要注意两点：</p>
<ol>
<li><p>链接库文件必须在 C 的动态链接库查找路径中，否则会报类似错误：</p>
<pre><code>luajit: ffimyc.lua:3: libffimyc.so: cannot open shared object file: No such file or directory
</code></pre><p> 引入方法：</p>
<pre><code> export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:your_lib_path

在 Linux 下，库函数名的查找与 C 程序查找动态链接库相同，如上面我生成的动态链接库文件为 libffimyc.so，我在 ffi.load 中的 name 为 ffimyc
</code></pre><p> 调用自己的函数，可以直接使用 ffi.load 返回的变量调用，下面我们看一个简单的例子：</p>
<pre><code>local ffi = require(&apos;ffi&apos;)
myc = ffi.load(&apos;ffimyc&apos;)

ffi.cdef[[
    int add(int x, int y);
]]

ret = myc.add(1, 20)
print(ret)
</code></pre><p>输出结果</p>
<pre><code>[root@AlexWoo-CentOS lua]# luajit ffimyc.lua
21
</code></pre></li>
<li><p>使用 ffi.C 调用自定义的 C 函数</p>
<p> 上面的例子中，是不能直接使用 ffi.C 来调用 add 函数的，那么怎么用 ffi.C 来调用 add 函数，对，就是 ffi.load 时，第二个参数置为 true，将库加载为全局命名空间。示例：</p>
<pre><code>local ffi = require(&apos;ffi&apos;)

ffi.load(&apos;ffimyc&apos;, true)

ffi.cdef[[
    int add(int x, int y);
]]

ret = ffi.C.add(1, 10)
print(ret)
</code></pre><p> 输出结果</p>
<pre><code>[root@AlexWoo-CentOS lua]# luajit ffimyc.lua
11
</code></pre><p>本节小结</p>
<p>在 lua 中调用 C 函数，需要使用 ffi.cdef 对 C 函数进行声明</p>
<p>对于 C 标准库函数，已在全局命名空间，直接可以使用 ffi.C.函数名(函数参数…) 来调用函数</p>
<p>对于自定义的 C 函数，需要将其先编译成链接库，并将链接库所在路径加入到 LD_LIBRARY_PATH 中，需要使用 ffi.load 载入链接库</p>
<p>如果 ffi.load 第二个参数不填写，链接库以私有空间方式链入 Lua 脚本，使用时需要用 ffi.load 的返回值对函数进行调用</p>
<p>如果 ffi.load 第二个参数设置为 true，可以使用 ffi.C 直接调用，调用方法同 C 标准库函数的调用</p>
</li>
</ol>
</li>
</ul>
<p>Lua 处理 cdata 对象</p>
<p>上面对 Lua 如何调用 C 函数进行了小结，但是光能调用 C 函数是远远不够的，我们还需要对 C 的变量，变量类型进行处理。本节将对这部分进行探讨。</p>
<p>C 类型转化为 Lua 中的 ctype</p>
<p>C 类型转化为 Lua ctype，使用 ffi.typeof，该函数返回一个 ctype 变量类型</p>
<pre><code>ctype = ffi.typeof(ct)
</code></pre><p>示例：</p>
<pre><code>local ffi = require(&apos;ffi&apos;)

ffi.cdef[[
    struct s1 {
        int a;
         int b;
    };
    typedef struct {
        int c;
            int d;
    } s2;
    union u {
           int a;
        long b;
        float c;
    };
    enum e {
            Male,
        Female
    };
]]

print(ffi.typeof(&quot;int8_t&quot;))
print(ffi.typeof(&quot;uint8_t&quot;))
print(ffi.typeof(&quot;int16_t&quot;))
print(ffi.typeof(&quot;uint16_t&quot;))
print(ffi.typeof(&quot;int32_t&quot;))
print(ffi.typeof(&quot;uint32_t&quot;))
print(ffi.typeof(&quot;int64_t&quot;))
print(ffi.typeof(&quot;uint64_t&quot;))
print(ffi.typeof(&quot;double&quot;))
print(ffi.typeof(&quot;float&quot;))
print(ffi.typeof(&quot;bool&quot;))
print(ffi.typeof(&quot;struct s1&quot;))
print(ffi.typeof(&quot;s2&quot;))
print(ffi.typeof(&quot;union u&quot;))
print(ffi.typeof(&quot;enum e&quot;))
print(ffi.typeof(&quot;struct s1*&quot;))
print(ffi.typeof(&quot;struct s1[]&quot;))
</code></pre><p>  输出：</p>
<pre><code>[root@AlexWoo-CentOS lua]# luajit ffit.lua 
ctype&lt;char&gt;
ctype&lt;unsigned char&gt;
ctype&lt;short&gt;
ctype&lt;unsigned short&gt;
ctype&lt;int&gt;
ctype&lt;unsigned int&gt;
ctype&lt;int64_t&gt;
ctype&lt;uint64_t&gt;
ctype&lt;double&gt;
ctype&lt;float&gt;
ctype&lt;bool&gt;
ctype&lt;struct s1&gt;
ctype&lt;struct 98&gt;
ctype&lt;union u&gt;
ctype&lt;enum e&gt;
ctype&lt;struct s1 *&gt;
ctype&lt;struct s1 []&gt;
</code></pre><p>  创建并初始化 cdata 对象</p>
<p>  使用 ctype 有以下两种构造 Lua C 对象的方法</p>
<pre><code>cdata = ffi.new(ct [,nelem] [,init...])
cdata = ctype([nelem,] [init...])
</code></pre><p>  基本类型 cdata 对象</p>
<p>  首先是一个 C 的函数，我们使用构造的 cadata 对象来调用该函数：</p>
<pre><code>int add(int x, int y)
{
    return x+y;
}
</code></pre><p>  直接调用</p>
<pre><code>local ffi = require(&apos;ffi&apos;)
local t = ffi.load(&quot;t&quot;, true)

ffi.cdef[[
    int add(int x, int y);
]]

print(t.add(10, 11))
</code></pre><p>  执行结果</p>
<pre><code>[root@AlexWoo-CentOS lua]# luajit ffit.lua 
21
</code></pre><p>  这种方法仅限于基本类型，lua 会将其基本类型转换为 cdata 的基本类型</p>
<p>  使用 ffi.new 构造</p>
<pre><code>local ffi = require(&apos;ffi&apos;)
local t = ffi.load(&quot;t&quot;, true)

ffi.cdef[[
    int add(int x, int y);
]]

ti = ffi.typeof(&quot;int&quot;)
a = ffi.new(ti, 10)
b = ffi.new(&quot;int&quot;, 11)
print(type(a), type(b))
print(t.add(a, b))
</code></pre><p>  执行结果</p>
<pre><code>[root@AlexWoo-CentOS lua]# luajit ffit.lua 
cdata   cdata
21
</code></pre><p>  这里如果执行 print(ffi.typeof(“int”))，结果就是 ctype，因此这里 ffi.new 的第一个参数直接填为 “int” 与传入一个 ctype 的类型对象是等价的</p>
<p>  使用类型对象构造</p>
<pre><code>local ffi = require(&apos;ffi&apos;)
local t = ffi.load(&quot;t&quot;, true)

ffi.cdef[[
    int add(int x, int y);
]]

ti = ffi.typeof(&quot;int&quot;)
a = ti(10)
b = ti(11)
print(t.add(a, b))
</code></pre><p>  执行结果</p>
<pre><code>[root@AlexWoo-CentOS lua]# luajit ffit.lua 
21
</code></pre><p>  基本类型指针 cdata 对象</p>
<p>  首先是一个 C 的函数，我们使用构造的 cadata 对象来调用该函数：</p>
<pre><code>int addp(int *x, int *y)
{
    return *x+*y;
}
</code></pre><p>  这里构造指针对象可以使用 ffi.new 和 类型构造两种方法，下面只以一种进行举例，其它举一反三</p>
<pre><code>local ffi = require(&apos;ffi&apos;)
local t = ffi.load(&quot;t&quot;, true)

ffi.cdef[[
    int add(int x, int y);
    int addp(int *x, int *y);
]]

a = ffi.new(&quot;int[1]&quot;, {10})
b = ffi.new(&quot;int[1]&quot;, {10})
print(t.addp(a, b))
</code></pre><p>  执行结果</p>
<pre><code>[root@AlexWoo-CentOS lua]# luajit ffit.lua 
21
</code></pre><p>  没有将 Lua 原生类型直接转换为指针类型的方法(至少我没找到)，这里使用的是将 Lua 的 table 转为只有一个元素的数组，并将数组当作指针类型参数传入addp中。</p>
<p>结构类型 cdata 对象</p>
<p>首先是一个 C 程序，我们使用构造的 cadata 对象来调用该函数：</p>
<pre><code>#include &lt;stdio.h&gt;

struct constr_t {
    int a;
    int b;
    struct innerstr {
        int x;
        int y;
    } c;
};

void print_constr_t(struct constr_t t)
{
    printf(&quot;a:%d\n&quot;, t.a);
    printf(&quot;b:%d\n&quot;, t.b);
    printf(&quot;c.x:%d\n&quot;, t.c.x);
    printf(&quot;c.y:%d\n&quot;, t.c.y);
}
</code></pre><p>Lua 程序</p>
<pre><code>local ffi = require(&apos;ffi&apos;)
local t = ffi.load(&quot;t&quot;, true)

ffi.cdef[[
    struct constr_t {
        int a;
        int b;
        struct innerstr {
            int x;
            int y;
        } c;
    };
    void print_constr_t(struct constr_t t);
]]

a = ffi.new(&quot;struct constr_t&quot;, {1, 2, {10, 11}})
t.print_constr_t(a)
</code></pre><p>执行结果</p>
<pre><code>[root@AlexWoo-CentOS lua]# luajit ffit.lua 
a:1
b:2
c.x:10
c.y:11
</code></pre><p>这里我们看到构造一个 C 的结构类型与基本类型的方法基本类似，唯一区别就是需要使用 table 来进行构造，table 的层次结构与 C 的结构的层次必须符合</p>
<p>结构类型指针 cdata 对象</p>
<p>在日常使用中，对于结构体，我们更常使用的是指针。和基本类型指针 cdata 对象不同，可以直接使用与结构类型 cdata 对象相同的方式来构造结构类型指针的 cdata 对象</p>
<p>C 程序</p>
<pre><code>#include &lt;stdio.h&gt;

struct constr_t {
    int a;
    int b;
    struct innerstr {
        int x;
        int y;
    } c;
};

void print_pconstr_t(struct constr_t *t)
{
    printf(&quot;a:%d\n&quot;, t-&gt;a);
    printf(&quot;b:%d\n&quot;, t-&gt;b);
    printf(&quot;c.x:%d\n&quot;, t-&gt;c.x);
    printf(&quot;c.y:%d\n&quot;, t-&gt;c.y);
}
</code></pre><p>Lua 程序</p>
<pre><code>local ffi = require(&apos;ffi&apos;)
local t = ffi.load(&quot;t&quot;, true)

ffi.cdef[[
    struct constr_t {
        int a;
        int b;
        struct innerstr {
            int x;
            int y;
        } c;
    };
    void print_pconstr_t(struct constr_t *t);
]]

a = ffi.new(&quot;struct constr_t&quot;, {1, 2, {10, 11}})
t.print_pconstr_t(a)
</code></pre><p>执行结果</p>
<pre><code>[root@AlexWoo-CentOS lua]# luajit ffit.lua 
a:1
b:2
c.x:10
c.y:11
</code></pre><p>字符串 cdata 对象</p>
<p>可以使用 Lua string 对象来初始化字符串 cdata 对象</p>
<p>C 程序</p>
<pre><code>void print(const char *s)
{
    printf(&quot;%s\n&quot;, s);
}
</code></pre><p>Lua 程序</p>
<pre><code>local ffi = require(&apos;ffi&apos;)
local t = ffi.load(&quot;t&quot;, true)

ffi.cdef[[
    void print(const char *s);
]]

a = ffi.new(&quot;const char*&quot;, &quot;Hello World&quot;)
t.print(a)
</code></pre><p>执行结果</p>
<pre><code>[root@AlexWoo-CentOS lua]# luajit ffit.lua 
Hello World
</code></pre><p>注意对字符串，ffi.new 第一个参数只能是 const char <em>、const char[size] 或 char[size]，不能是 char </em>，const char[?] 等类型</p>
<p>使用 cdata 对象</p>
<p>本节将探讨在 Lua 中怎么使用 cdata 对象</p>
<p>C 程序</p>
<pre><code>#include &lt;stdio.h&gt;

struct constr_t {
    int a;
    int b;
    struct innerstr {
        int x;
        int y;
    } c;
};

void print_pconstr_t(struct constr_t *t)
{
    printf(&quot;a:%d\n&quot;, t-&gt;a);
    printf(&quot;b:%d\n&quot;, t-&gt;b);
    printf(&quot;c.x:%d\n&quot;, t-&gt;c.x);
    printf(&quot;c.y:%d\n&quot;, t-&gt;c.y);
}

int print_i(int x)
{
    printf(&quot;x: %d\n&quot;, x);
}

int print_pi(int *px)
{
    printf(&quot;px: %d\n&quot;, *px);
}

void print(const char *s)
{
    printf(&quot;%s\n&quot;, s);
}
</code></pre><p>Lua 程序</p>
<pre><code>local ffi = require(&apos;ffi&apos;)
local t = ffi.load(&quot;t&quot;, true)

ffi.cdef[[
    struct constr_t {
        int a;
        int b;
        struct innerstr {
            int x;
            int y;
        } c;
    };
    void print_pconstr_t(struct constr_t *t);
    int print_i(int x);
    int print_pi(int *px);
    void print(const char *s);
]]

ti = ffi.new(&quot;int&quot;, 10)
tpi = ffi.new(&quot;int[1]&quot;, {20})

ts = ffi.new(&quot;struct constr_t&quot;, {1, 2, {3, 4}})

tcstr = ffi.new(&quot;const char*&quot;, &quot;Hello World&quot;)
tstr = ffi.new(&quot;char[11]&quot;, &quot;Hello World&quot;)

t.print_i(ti)
--t.print_pi(ti) --luajit: ffit.lua:29: bad argument #1 to &apos;print_pi&apos; (cannot convert &apos;int&apos; to &apos;int *&apos;)

--t.print_i(tpi) --luajit: ffit.lua:31: bad argument #1 to &apos;print_i&apos; (cannot convert &apos;int [1]&apos; to &apos;int&apos;)
t.print_pi(tpi)

t.print_pconstr_t(ts)

t.print(tcstr)
t.print(tstr)
</code></pre><p>–对基本类型操作</p>
<pre><code>ti = 100 --change tpi to number
tpi[0] = 21
--tpi=22 --change tpi to number
--tpi[1] = 2000 --luajit: ffit.lua:44: attempt to index global &apos;tpi&apos; (a number value)
print(type(ti), type(tpi))
t.print_i(ti)
t.print_pi(tpi)
</code></pre><p>–对 struct 类型操作</p>
<pre><code>ts.b = 100
ts.c.y = 1000
print(type(ts))
t.print_pconstr_t(ts)
</code></pre><p>–对字符串类型操作</p>
<pre><code>--tcstr[2] = 32 --luajit: ffit.lua:54: attempt to write to constant location
tstr[2] = 32
t.print(tstr)

t.print(&quot;Hello Lua&quot;)
</code></pre><p>执行结果</p>
<pre><code>[root@AlexWoo-CentOS lua]# luajit ffit.lua 
x: 10
px: 20
a:1
b:2
c.x:3
c.y:4
Hello World
Hello World
number  cdata
x: 100
px: 21
cdata    
a:1
b:100
c.x:3
c.y:1000
Hello World
Hello Lua
</code></pre><p>从上面的例子可以看出，对基本类型，实际上不需要将其转为 cdata 类型；对于基本类型指针，操作方式与数组类似，在 Lua 中可当作 table 数组进行处理；对结构类型，在 Lua 中可当作 table 字典进行处理；对字符串，在 Lua 中可当作 table 数组进行处理</p>
<p>本节小结</p>
<p>Lua 可以使用 ffi.new 初始化一个 cdata 对象，也可以使用 ffi.typeof 生成的类型来初始化一个 cdata 对象</p>
<p>对于基本类型和字符串类型，没有必要将其转为 cdata 对象，其可以作为参数传入 C 函数中。也可以接收 C 函数的返回值</p>
<p>对于基本类型指针对象，可以使用单元素数组进行初始化，可以使用数组元素赋值的方式改变其中的值</p>
<p>对于结构类型，可以传入 C 指针参数，也可以传入 C 普通参数。对结构类型的操作，与 table 的字典操作类似</p>
<p>原文出自: <a href="http://blog.csdn.net/alexwoo0501/article/details/50636785" target="_blank" rel="external">http://blog.csdn.net/alexwoo0501/article/details/50636785</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/05/2016-06-19-openresty-note.html" itemprop="url">
                  openresty学习笔记
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-07-05T21:29:45+08:00" content="2016-07-05">
              2016-07-05
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/07/05/2016-06-19-openresty-note.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/07/05/2016-06-19-openresty-note.html" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
            &nbsp; | &nbsp;
            <span id="/2016/07/05/2016-06-19-openresty-note.html"class="leancloud_visitors" data-flag-title="openresty学习笔记">
                     &nbsp;阅读次数
                    </span>
          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ol>
<li><p>lua_package_path “conf/lua/?.lua”; 表示多个字符串的通配符为？，不是 *</p>
</li>
<li><p>lua中涉及到路径，如果没有指定绝对路径，那前缀为 安装 openresty 的 路径前缀。比如</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">        lua_package_path <span class="string">"lua/?.lua"</span>  ：路径为/usr/<span class="keyword">local</span>/openresty/lua/?.lua</div><div class="line">        access_by_lua_file lua/access_check.lua ：   路径为/usr/<span class="keyword">local</span>/openresty/lua/access_check.lua</div><div class="line">     </div><div class="line">   ``` </div><div class="line"></div><div class="line"><span class="number">3.</span> ngx.var.arg_a ： 获取url中参数a的值；   </div><div class="line"></div><div class="line">     ngx.var.内部变量名：获取内部变量值，如ngx.var.remote_addr    获取访问用户地址</div><div class="line">   Setting ngx.var.Foo to a <span class="keyword">nil</span> value will unset the $Foo Nginx variable.</div><div class="line">  </div><div class="line">    ```lua      </div><div class="line">      ngx.var.args = <span class="keyword">nil</span></div><div class="line">    ```      </div><div class="line">  </div><div class="line"><span class="number">4.</span> ngx.var.limit_rate = <span class="number">1000</span>    限速，注意：并不是每个nginx内置变量都可以改变。</div><div class="line"></div><div class="line"><span class="number">5.</span> 如果需要在Lua中处理错误，必须使用函数<span class="built_in">pcall</span>（protected call）来包装需要执行的代码。 <span class="built_in">pcall</span>接收一个函数和要传递给后者的参数，并执行，执行结果：有错误、无错误；返回值<span class="keyword">true</span>或者或<span class="keyword">false</span>, errorinfo。<span class="built_in">pcall</span>以一种<span class="string">"保护模式"</span>来调用第一个参数，因此<span class="built_in">pcall</span>可以捕获函数执行中的任何错误。</div><div class="line"></div><div class="line">   ```lua</div><div class="line">      <span class="built_in">pcall</span>(<span class="function"><span class="keyword">function</span> <span class="params">(str)</span></span> json_value = json.decode(str) <span class="keyword">end</span>, str)</div></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p>debug</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">lua_code_cache off;</div></pre></td></tr></table></figure>
<p>修改完代码后，不用reload nginx就可以生效了。在生产环境下记得打开这个选项。</p>
</li>
<li><p>读取post数据：curl -XPOST ‘xxxxx/test’ -d ‘a=xxx&amp;b=yyy’</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ngx.req.read_body()  <span class="comment">-- explicitly read the req body</span></div><div class="line"><span class="keyword">local</span> data = ngx.req.get_body_data()     =&gt; a=xxx&amp;b=yyy</div></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p>local file = ngx.req.get_body_file()  获取文件内容</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -XPOST <span class="string">'xxxxx/test'</span> -d <span class="string">'@/etc/passwd'</span>  file的值为本地文件/etc/passwd的内容。</div></pre></td></tr></table></figure>
</li>
<li><p>ngx.location.capture</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"> res = ngx.location.capture(<span class="string">"/some_other_location"</span>)</div><div class="line">``` </div><div class="line">  </div><div class="line"> res结果是 http://xxxxx/some_other_location 这个链接的输出。</div><div class="line">  </div><div class="line"> Issuing a POST subrequest, <span class="keyword">for</span> example, can be done as follows</div><div class="line"></div><div class="line">```lua</div><div class="line">  res = ngx.location.capture(</div><div class="line">    <span class="string">'/foo/bar'</span>,</div><div class="line">    &#123; method = ngx.HTTP_POST, body = <span class="string">'hello, world'</span> &#125;</div><div class="line">  )</div></pre></td></tr></table></figure>
</li>
</ol>
<pre><code>res包括： 
res.status, res.header, res.body, and res.truncated

The args option can specify extra URI arguments, for instance,
</code></pre>   <figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ngx.location.capture(<span class="string">'/foo?a=1'</span>,</div><div class="line">    &#123; args = &#123; b = <span class="number">3</span>, c = <span class="string">':'</span> &#125; &#125;</div><div class="line">)</div></pre></td></tr></table></figure>
<pre><code>is equivalent to
</code></pre>   <figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ngx.location.capture(<span class="string">'/foo?a=1&amp;b=3&amp;c=%3a'</span>)</div></pre></td></tr></table></figure>
<pre><code>that is, this method will escape argument keys and values according to URI rules and concatenate them together into a complete query string. The format for the Lua table passed as the args argument is identical to the format used in thengx.encode_args method.

The args option can also take plain query strings:
</code></pre>   <figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ngx.location.capture(<span class="string">'/foo?a=1'</span>,</div><div class="line">    &#123; args = <span class="string">'b=3&amp;c=%3a'</span> &#125; &#125;</div><div class="line">)</div></pre></td></tr></table></figure>
<pre><code>ngx.location.capture_multi :同时捕获多个链接输出

The ngx.location.capture and ngx.location.capture_multi directives cannot capture locations that include the add_before_body, add_after_body, auth_request, echo_location, echo_location_async, echo_subrequest, or echo_subrequest_async directives.
</code></pre>   <figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">res1, res2, res3 = ngx.location.capture_multi&#123;</div><div class="line">   &#123; <span class="string">"/foo"</span>, &#123; args = <span class="string">"a=3&amp;b=4"</span> &#125; &#125;,</div><div class="line">   &#123; <span class="string">"/bar"</span> &#125;,</div><div class="line">   &#123; <span class="string">"/baz"</span>, &#123; method = ngx.HTTP_POST, body = <span class="string">"hello"</span> &#125; &#125;,</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> res1.status == ngx.HTTP_OK <span class="keyword">then</span></div><div class="line">  ...</div><div class="line"><span class="keyword">end</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> res2.body == <span class="string">"BLAH"</span> <span class="keyword">then</span></div><div class="line">  ...</div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<pre><code>Lua tables can be used for both requests and responses when the number of subrequests to be issued is not known in advance:
</code></pre>   <figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- construct the requests table</span></div><div class="line"><span class="keyword">local</span> reqs = &#123;&#125;</div><div class="line"><span class="built_in">table</span>.insert(reqs, &#123; <span class="string">"/mysql"</span> &#125;)</div><div class="line"><span class="built_in">table</span>.insert(reqs, &#123; <span class="string">"/postgres"</span> &#125;)</div><div class="line"><span class="built_in">table</span>.insert(reqs, &#123; <span class="string">"/redis"</span> &#125;)</div><div class="line"><span class="built_in">table</span>.insert(reqs, &#123; <span class="string">"/memcached"</span> &#125;)</div><div class="line">    </div><div class="line"><span class="comment">-- issue all the requests at once and wait until they all return</span></div><div class="line"><span class="keyword">local</span> resps = &#123; ngx.location.capture_multi(reqs) &#125;</div><div class="line">    </div><div class="line"><span class="comment">-- loop over the responses table</span></div><div class="line"><span class="keyword">for</span> i, resp <span class="keyword">in</span> <span class="built_in">ipairs</span>(resps) <span class="keyword">do</span></div><div class="line">    <span class="comment">-- process the response table "resp"</span></div><div class="line"><span class="keyword">end</span></div></pre></td></tr></table></figure>
<ol>
<li><p>Capture</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">location ~ ^/app/([-_a-zA-Z0<span class="number">-9</span>/]+) &#123;</div><div class="line">    set $path $<span class="number">1</span>;   $<span class="number">1</span>为location中匹配到的部分</div><div class="line">    content_by_lua_file /path/to/lua/app/root/$path.lua;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p>重定向</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ngx.redirect(<span class="string">"/terms_of_use.html"</span>) ：重定向</div></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p>伪异步</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nginx.eof():</div></pre></td></tr></table></figure>
</li>
</ol>
<pre><code>与客户端断开连接，但是继续向下执行以后的代码，此时nginx进程还没有释放,类似php的fastcgi_request_finish.
</code></pre><ol>
<li><p>ngx.say &amp;&amp; ngx.print</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ngx.say、ngx.<span class="built_in">print</span>：功能一样，say会额外输出一个换行</div></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p>set</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">set $foo <span class="number">32</span>;</div><div class="line">set_by_lua $bar <span class="string">'return tonumber(ngx.var.foo) + 1'</span>;</div><div class="line">set $baz <span class="string">"bar: $bar"</span>;  # $baz == <span class="string">"bar: 33"</span></div></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p>header_filter_by_lua：增加response header</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">location / &#123;</div><div class="line">   proxy_pass http://mybackend;</div><div class="line">   header_filter_by_lua <span class="string">'ngx.header.Foo = "blah"'</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p>ngx.arg</p>
<p>When this is used in the context of the set_by_lua or set_by_lua_file directives, this table is read-only and holds the input arguments to the config directives:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">value = ngx.arg[n]</div></pre></td></tr></table></figure>
</li>
</ol>
<pre><code>Here is an example

<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">location /foo &#123;</div><div class="line">   set $a <span class="number">32</span>;</div><div class="line">   set $b <span class="number">56</span>;</div><div class="line"></div><div class="line">   set_by_lua $sum</div><div class="line">      <span class="string">'return tonumber(ngx.arg[1]) +     tonumber(ngx.arg[2])'</span> $a $b;</div><div class="line">   echo $sum;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>


that writes out 88, the sum of 32 and 56.
</code></pre><ol>
<li><p>HTTP方法常量</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">ngx.HTTP_GET</div><div class="line">ngx.HTTP_HEAD</div><div class="line">ngx.HTTP_PUT</div><div class="line">ngx.HTTP_POST</div><div class="line">ngx.HTTP_DELETE</div><div class="line">ngx.HTTP_OPTIONS   (added <span class="keyword">in</span> the v0<span class="number">.5</span><span class="number">.0</span>rc24 release)</div><div class="line">ngx.HTTP_MKCOL     (added <span class="keyword">in</span> the v0<span class="number">.8</span><span class="number">.2</span> release)</div><div class="line">ngx.HTTP_COPY      (added <span class="keyword">in</span> the v0<span class="number">.8</span><span class="number">.2</span> release)</div><div class="line">ngx.HTTP_MOVE      (added <span class="keyword">in</span> the v0<span class="number">.8</span><span class="number">.2</span> release)</div><div class="line">ngx.HTTP_PROPFIND  (added <span class="keyword">in</span> the v0<span class="number">.8</span><span class="number">.2</span> release)</div><div class="line">ngx.HTTP_PROPPATCH (added <span class="keyword">in</span> the v0<span class="number">.8</span><span class="number">.2</span> release)</div><div class="line">ngx.HTTP_LOCK      (added <span class="keyword">in</span> the v0<span class="number">.8</span><span class="number">.2</span> release)</div><div class="line">ngx.HTTP_UNLOCK    (added <span class="keyword">in</span> the v0<span class="number">.8</span><span class="number">.2</span> release)</div><div class="line">ngx.HTTP_PATCH     (added <span class="keyword">in</span> the v0<span class="number">.8</span><span class="number">.2</span> release)</div><div class="line">ngx.HTTP_TRACE     (added <span class="keyword">in</span> the v0<span class="number">.8</span><span class="number">.2</span> release)</div></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p>HTTP status常量</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">value = ngx.HTTP_OK (<span class="number">200</span>)</div><div class="line">value = ngx.HTTP_CREATED (<span class="number">201</span>)</div><div class="line">value = ngx.HTTP_SPECIAL_RESPONSE (<span class="number">300</span>)</div><div class="line">value = ngx.HTTP_MOVED_PERMANENTLY (<span class="number">301</span>)</div><div class="line">value = ngx.HTTP_MOVED_TEMPORARILY (<span class="number">302</span>)</div><div class="line">value = ngx.HTTP_SEE_OTHER (<span class="number">303</span>)</div><div class="line">value = ngx.HTTP_NOT_MODIFIED (<span class="number">304</span>)</div><div class="line">value = ngx.HTTP_BAD_REQUEST (<span class="number">400</span>)</div><div class="line">value = ngx.HTTP_UNAUTHORIZED (<span class="number">401</span>)</div><div class="line">value = ngx.HTTP_FORBIDDEN (<span class="number">403</span>)</div><div class="line">value = ngx.HTTP_NOT_FOUND (<span class="number">404</span>)</div><div class="line">value = ngx.HTTP_NOT_ALLOWED (<span class="number">405</span>)</div><div class="line">value = ngx.HTTP_GONE (<span class="number">410</span>)</div><div class="line">value = ngx.HTTP_INTERNAL_SERVER_ERROR (<span class="number">500</span>)</div><div class="line">value = ngx.HTTP_METHOD_NOT_IMPLEMENTED (<span class="number">501</span>)</div><div class="line">value = ngx.HTTP_SERVICE_UNAVAILABLE (<span class="number">503</span>)</div><div class="line">value = ngx.HTTP_GATEWAY_TIMEOUT (<span class="number">504</span>) (first added <span class="keyword">in</span> the v0<span class="number">.3</span><span class="number">.1</span>rc38 release)</div></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p>Nginx log level constants</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">ngx.STDERR</div><div class="line">ngx.EMERG</div><div class="line">ngx.ALERT</div><div class="line">ngx.CRIT</div><div class="line">ngx.ERR</div><div class="line">ngx.WARN</div><div class="line">ngx.NOTICE</div><div class="line">ngx.INFO</div><div class="line">ngx.DEBUG</div></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p>ngx.ctx：在一个请求中传递变量<br>This table can be used to store per-request Lua context data and has a life time identical to the current request (as with the Nginx variables).<br>Consider the following example,</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"> location /test &#123;</div><div class="line">     rewrite_by_lua '</div><div class="line">         ngx.ctx.foo = 76</div><div class="line">     ';</div><div class="line">     access_by_lua '</div><div class="line">         ngx.ctx.foo = ngx.ctx.foo + 3</div><div class="line">     ';</div><div class="line">     content_by_lua '</div><div class="line">         ngx.say(ngx.ctx.foo)</div><div class="line">     ';</div><div class="line"> &#125;</div><div class="line">```   </div><div class="line"></div><div class="line">Then GET /test will yield the output</div><div class="line">  </div><div class="line">```lua</div><div class="line">79</div></pre></td></tr></table></figure>
</li>
</ol>
<pre><code>That is, the ngx.ctx.foo entry persists across the rewrite, access, and content phases of a request.
Every request, including subrequests, has its own copy of the table. For example:

<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">location /sub &#123;</div><div class="line">    content_by_lua '</div><div class="line">        ngx.say("sub pre: ", ngx.ctx.blah)</div><div class="line">        ngx.ctx.blah = 32</div><div class="line">        ngx.say("sub post: ", ngx.ctx.blah)</div><div class="line">    ';</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">location /main &#123;</div><div class="line">    content_by_lua '</div><div class="line">        ngx.ctx.blah = 73</div><div class="line">        ngx.say("main pre: ", ngx.ctx.blah)</div><div class="line">        local res = ngx.location.capture("/sub")</div><div class="line">        ngx.print(res.body)</div><div class="line">        ngx.say("main post: ", ngx.ctx.blah)</div><div class="line">    ';</div><div class="line">&#125;</div></pre></td></tr></table></figure>

Then GET /main will give the output

<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">main pre: <span class="number">73</span></div><div class="line">sub pre: <span class="keyword">nil</span></div><div class="line">sub post: <span class="number">32</span></div><div class="line">main post: <span class="number">73</span></div></pre></td></tr></table></figure>


Here, modification of the ngx.ctx.blah entry in the subrequest does not affect the one in the parent request. This is because they have two separate versions of ngx.ctx.blah.

Internal redirection will destroy the original request ngx.ctx data (if any) and the new request will have an empty ngx.ctxtable. For instance,

<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">location /new &#123;</div><div class="line">    content_by_lua '</div><div class="line">        ngx.say(ngx.ctx.foo)</div><div class="line">    ';</div><div class="line">&#125;</div><div class="line">    </div><div class="line">location /orig &#123;</div><div class="line">    content_by_lua '</div><div class="line">        ngx.ctx.foo = "hello"</div><div class="line">        ngx.exec("/new")</div><div class="line">    ';</div><div class="line">&#125;</div></pre></td></tr></table></figure>


Then GET /orig will give

<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">nil</span></div></pre></td></tr></table></figure>
</code></pre><ol>
<li><p>ngx.status：设置或获取nginx status</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ngx.status = ngx.HTTP_CREATED</div><div class="line">status = ngx.status</div></pre></td></tr></table></figure>
<p>Setting ngx.status after the response header is sent out has no effect,but leaving an error message in your nginx’s error log file:<br>attempt to set ngx.status after sending out response headers</p>
</li>
<li><p>ngx.header.HEADER</p>
<p>syntax: ngx.header.HEADER = VALUE<br>syntax: value = ngx.header.HEADER<br>header name中的下划线默认会被替换成中划线,lua_transform_underscores_in_response_headers可以关闭。<br>The header names are matched </p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">case-insensitively：大小写不敏感.</div></pre></td></tr></table></figure>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"> <span class="comment">-- equivalent to ngx.header["Content-Type"] = 'text/plain'</span></div><div class="line"> ngx.header.content_type = <span class="string">'text/plain'</span>;</div><div class="line"></div><div class="line"> ngx.header[<span class="string">"X-My-Header"</span>] = <span class="string">'blah blah'</span>;</div><div class="line">Multi-value headers can be set this way:</div><div class="line"></div><div class="line"> ngx.header[<span class="string">'Set-Cookie'</span>] = &#123;<span class="string">'a=32; path=/'</span>, <span class="string">'b=4; path=/'</span>&#125;</div><div class="line">will yield</div><div class="line"></div><div class="line"> Set-Cookie: a=<span class="number">32</span>; path=/</div><div class="line"> Set-Cookie: b=<span class="number">4</span>; path=/</div></pre></td></tr></table></figure>
<p>in the response headers.</p>
<p>Setting a slot to nil effectively removes it from the response headers:</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ngx.header[<span class="string">"X-My-Header"</span>] = <span class="keyword">nil</span>;</div></pre></td></tr></table></figure>
</li>
</ol>
<pre><code>The same applies to assigning an empty table:

<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ngx.header[<span class="string">"X-My-Header"</span>] = &#123;&#125;;</div></pre></td></tr></table></figure>


This is particularly useful in the context of header_filter_by_lua and header_filter_by_lua_file, for example,

<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">location /test &#123;</div><div class="line">    set $footer '';</div><div class="line">    </div><div class="line">    proxy_pass http://some-backend;</div><div class="line">    </div><div class="line">    header_filter_by_lua '</div><div class="line">        if ngx.header["X-My-Header"] == "blah" then</div><div class="line">            ngx.var.footer = "some value"</div><div class="line">        end</div><div class="line">    ';</div><div class="line">    </div><div class="line">    echo_after_body $footer;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

For multi-value headers, all of the values of header will be collected in order and returned as a Lua table. For example, response headers Foo: bar Foo: baz 
will result in

<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;<span class="string">"bar"</span>, <span class="string">"baz"</span>&#125;</div></pre></td></tr></table></figure>


to be returned when reading ngx.header.Foo.
</code></pre><ol>
<li><p>ngx.resp.get_headers/ngx.req.get_headers：获取header</p>
<p>syntax: headers = ngx.resp.get_headers(max_headers?, raw?)<br>context: set_by_lua, rewrite_by_lua, access_by_lua, content_by_lua, header_filter_by_lua, body_filter_by_lua, log_by_lua**</p>
<p>Returns a Lua table holding all the current response headers for the current request.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">local h = ngx.req.get_headers()</div><div class="line">for k, v in pairs(h) do</div><div class="line">    ngx.say("Req Header ---&gt; " .. k .. "==&gt; ' .. v)</div><div class="line">end</div><div class="line"></div><div class="line">local h = ngx.resp.get_headers()</div><div class="line">for k, v in pairs(h) do</div><div class="line">    ngx.say("Resp Header &lt;---- " .. k .. "==&gt; ' .. v)</div><div class="line">end</div><div class="line"></div><div class="line">header_filter_by_lua_block &#123;</div><div class="line">    ngx.header.X-Foo-bar = "Hit"</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p>ngx.req.start_time:返回当前请求被创建的时间</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">local</span> request_time = ngx.now() - ngx.req.start_time()</div></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p>ngx.req.http_version获取 http 版本</p>
</li>
<li><p>ngx.req.raw_header(bool no_request_line):获取原始header字符串</p>
<p>参数no_request_line决定是否返回 ‘GET /t HTTP/1.1’ 类似的请求信息</p>
</li>
<li><p>ngx.req.get_method()、ngx.req.set_method：获取、设置method</p>
</li>
<li><p>ngx.req.set_uri</p>
<p>syntax: ngx.req.set_uri(uri, jump?)<br>For instance, Nginx config</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rewrite ^ /foo?a=<span class="number">3</span>? last;</div></pre></td></tr></table></figure>
</li>
</ol>
<pre><code>can be coded as

<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ngx.req.set_uri_args(<span class="string">"a=3"</span>)</div><div class="line">ngx.req.set_uri(<span class="string">"/foo"</span>, <span class="keyword">true</span>)</div></pre></td></tr></table></figure>


or

<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ngx.req.set_uri_args(&#123;a = <span class="number">3</span>&#125;)</div><div class="line">ngx.req.set_uri(<span class="string">"/foo"</span>, <span class="keyword">true</span>)</div></pre></td></tr></table></figure>
</code></pre><ol>
<li><p>ngx.req.set_uri_args</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ngx.req.set_uri_args(<span class="string">"a=3&amp;b=hello%20world"</span>)   </div><div class="line">ngx.req.set_uri_args(&#123; a = <span class="number">3</span>, b = <span class="string">"hello world"</span> &#125;) 效果相同</div><div class="line">ngx.req.set_uri_args(&#123; a = <span class="number">3</span>, b = &#123;<span class="number">5</span>, <span class="number">6</span>&#125; &#125;)  <span class="comment">--&gt;  a=3&amp;b=5&amp;b=6.</span></div></pre></td></tr></table></figure>
</li>
</ol>
<ol>
<li><p>ngx.req.get_uri_args：获取url参数</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">location = /test &#123;</div><div class="line">     content_by_lua '</div><div class="line">         local args = ngx.req.get_uri_args()</div><div class="line">         for key, val in pairs(args) do</div><div class="line">             if type(val) == "table" then</div><div class="line">                 ngx.say(key, ": ", table.concat(val, ", "))</div><div class="line">             else</div><div class="line">                 ngx.say(key, ": ", val)</div><div class="line">             end</div><div class="line">         end</div><div class="line">     ';</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>Then GET /test?foo=bar&amp;bar=baz&amp;bar=blah will yield the response body</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">foo: bar</div><div class="line">bar: baz, blah</div></pre></td></tr></table></figure>
</li>
</ol>
<pre><code>Arguments without the = parts are treated as boolean arguments. GET /test?foo&amp;bar will yield:

<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">foo: <span class="keyword">true</span></div><div class="line">bar: <span class="keyword">true</span></div></pre></td></tr></table></figure>


GET /test?foo=&amp;bar= will give something like

<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">foo:</div><div class="line">bar:</div></pre></td></tr></table></figure>


Updating query arguments via the nginx variable $args (or ngx.var.args in Lua) at runtime is also supported:

<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ngx.var.args = <span class="string">"a=3&amp;b=42"</span></div><div class="line"><span class="keyword">local</span> args = ngx.req.get_uri_args()</div></pre></td></tr></table></figure>


Here the args table will always look like

<figure class="highlight lua"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;a = <span class="number">3</span>, b = <span class="number">42</span>&#125;</div></pre></td></tr></table></figure>
</code></pre><ol>
<li><p>在一个nignx worker内共享数据</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">-- mydata.lua</div><div class="line"> local _M = &#123;&#125;</div><div class="line"></div><div class="line"> local data = &#123;</div><div class="line">     dog = 3,</div><div class="line">     cat = 4,</div><div class="line">     pig = 5,</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> function _M.get_age(name)</div><div class="line">     return data[name]</div><div class="line"> end</div><div class="line"> function _M.set_age(name,value)</div><div class="line">     data[name] = value</div><div class="line"> end</div><div class="line"> return _M</div><div class="line"></div><div class="line">location /lua &#123;</div><div class="line">    content_by_lua '</div><div class="line">        local mydata = require "mydata"</div><div class="line">        ngx.say(mydata.get_age("dog"))</div><div class="line">        mydata.set_age("dog",1111)</div><div class="line"> ';</div><div class="line">&#125;</div><div class="line">```    </div><div class="line"></div><div class="line">连续访问两次，第一次输出3 ，第二次输出1111</div><div class="line"></div><div class="line">注意：需要以下设置才能生效：</div><div class="line">  </div><div class="line">```lua</div><div class="line">worker_processes  1;  //多个进程时，可能需要刷新多次才能出现</div><div class="line">lua_code_cache on;</div></pre></td></tr></table></figure>
</li>
</ol>
<p><b>最后</b>:</p>
<ul>
<li>尽量在声明变量时使用local</li>
<li>使用ngx.var,ngx.print等的时候也尽量设定为本地变量</li>
<li>错误处理需要使用pcall 包装要执行的代码</li>
<li>使用require加载模块</li>
<li>请求返回可以继续执行任务(fastcgi_finish, ngx.eof()) 尾调用</li>
<li>连接池使用(set_keep_alive, redis/mysql要用)</li>
<li>数组下标1 #aa 可以获取数组大小，但是千万不要使用</li>
<li><p>ffi的使用</p>
<p>参考: <a href="http://chattool.sinaapp.com/?p=493" target="_blank" rel="external">phper</a></p>
</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/07/05/2015-09-06-Hello-World.html" itemprop="url">
                  博客搬到新家啦
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-07-05T21:27:11+08:00" content="2016-07-05">
              2016-07-05
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/07/05/2015-09-06-Hello-World.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/07/05/2015-09-06-Hello-World.html" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
            &nbsp; | &nbsp;
            <span id="/2016/07/05/2015-09-06-Hello-World.html"class="leancloud_visitors" data-flag-title="博客搬到新家啦">
                     &nbsp;阅读次数
                    </span>
          
          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这是我的第一篇blog，Hello World</p>
<blockquote>
<p>Hello World</p>
</blockquote>
<p><a href="http://skey4.tumblr.com/" target="_blank" rel="external">旧版blog地址</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="sky" />
          <p class="site-author-name" itemprop="name">sky</p>
          <p class="site-description motion-element" itemprop="description">前进，前进，不择手段的野蛮前进。</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">13</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">sky</span>
</div>

<div class="powered-by">
  Powered By <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"skey4"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  
  

  
  
    <!-- custom analytics part create by xiamo -->
<script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
<script>AV.initialize("CrujEsuoGcEj8uRxgKyJYcfX-gzGzoHsz", "eWKCvj9p1JLbhdc5Y8xXK27K");</script>
<script>
function showTime(Counter) {
    var query = new AV.Query(Counter);
    $(".leancloud_visitors").each(function() {
        var url = $(this).attr("id").trim();
        query.equalTo("url", url);
        query.find({
            success: function(results) {
                if (results.length == 0) {
                    var content = $(document.getElementById(url)).text() + ': 0';
                    $(document.getElementById(url)).text(content);
                    return;
                }
                for (var i = 0; i < results.length; i++) {
                    var object = results[i];
                    var content = $(document.getElementById(url)).text() + ': ' + object.get('time');
                    $(document.getElementById(url)).text(content);
                }
            },
            error: function(object, error) {
                console.log("Error: " + error.code + " " + error.message);
            }
        });

    });
}

function addCount(Counter) {
    var Counter = AV.Object.extend("Counter");
    url = $(".leancloud_visitors").attr('id').trim();
    title = $(".leancloud_visitors").attr('data-flag-title').trim();
    var query = new AV.Query(Counter);
    query.equalTo("url", url);
    query.find({
        success: function(results) {
            if (results.length > 0) {
                var counter = results[0];
                counter.fetchWhenSave(true);
                counter.increment("time");
                counter.save(null, {
                    success: function(counter) {
                        var content = $(document.getElementById(url)).text() + ': ' + counter.get('time');
                        $(document.getElementById(url)).text(content);
                    },
                    error: function(counter, error) {
                        console.log('Failed to save Visitor num, with error message: ' + error.message);
                    }
                });
            } else {
                var newcounter = new Counter();
                newcounter.set("title", title);
                newcounter.set("url", url);
                newcounter.set("time", 1);
                newcounter.save(null, {
                    success: function(newcounter) {
                        console.log("newcounter.get('time')="+newcounter.get('time'));
                        var content = $(document.getElementById(url)).text() + ': ' + newcounter.get('time');
                        $(document.getElementById(url)).text(content);
                    },
                    error: function(newcounter, error) {
                        console.log('Failed to create');
                    }
                });
            }
        },
        error: function(error) {
            console.log('Error:' + error.code + " " + error.message);
        }
    });
}
$(function() {
    var Counter = AV.Object.extend("Counter");
    if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
    } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
    }
}); 
</script>


  
</body>
</html>
